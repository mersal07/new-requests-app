<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="theme-color" content="#5C2D91">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>New Requests Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* TE.eg Color Palette */
            --bg: #F3F3F3;
            --bg-solid: #F3F3F3;
            --surface: #ffffff;
            --surface-solid: #ffffff;
            --text: #333333;
            --text-secondary: #555555;
            --muted: #777777;
            --accent: #92278F;
            --accent-dark: #5C2D91;
            --accent-light: #b44eb1;
            --accent-gradient: linear-gradient(135deg, #5C2D91 0%, #92278F 100%);
            --highlight: #FFCC00;
            --ok: #28a745;
            --ok-light: #d4edda;
            --border: #e0e0e0;
            --border-strong: #cccccc;
            --chip: #f8f8f8;
            --r: 8px;
            --r-sm: 6px;
            --danger: #dc3545;
            --danger-light: #f8d7da;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --blur: blur(12px);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1a1a2e;
                --bg-solid: #1a1a2e;
                --surface: #252540;
                --surface-solid: #252540;
                --text: #f0f0f0;
                --text-secondary: #c0c0c0;
                --muted: #999999;
                --accent: #b44eb1;
                --accent-dark: #92278F;
                --accent-light: #c77dc5;
                --accent-gradient: linear-gradient(135deg, #5C2D91 0%, #b44eb1 100%);
                --ok: #34d399;
                --ok-light: rgba(40, 167, 69, 0.2);
                --border: #3a3a5c;
                --border-strong: #4a4a6c;
                --chip: #2a2a45;
                --danger: #f87171;
                --danger-light: rgba(220, 53, 69, 0.2);
                --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
                --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a {
            color: var(--accent);
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        a:hover {
            opacity: 0.8;
        }

        /* Header - Clean WE style */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--accent-gradient);
            border-bottom: none;
            padding: 10px 12px;
            box-shadow: var(--shadow-md);
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.01em;
        }

        .muted {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.7rem;
            margin-top: 2px;
            font-weight: 400;
        }

        .userbar {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .userpill {
            display: inline-flex;
            gap: 0.35rem;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--r-sm);
            font-weight: 600;
            font-size: 0.7rem;
            color: #ffffff;
            transition: all 0.2s ease;
        }

        .userpill:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .linkish {
            cursor: pointer;
            color: var(--highlight);
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 2px;
            transition: all 0.2s ease;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .linkish:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            margin: 8px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* Filters - Compact grid layout */
        .filters-card {
            position: sticky;
            top: 48px;
            z-index: 40;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 10px;
        }

        @media (min-width: 480px) {
            .filters {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-weight: 600;
            font-size: 0.68rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .filters select {
            height: 28px;
            min-height: 28px;
            padding: 0 8px;
            border-radius: var(--r-sm);
            border: 1px solid var(--border-strong);
            background: var(--surface-solid);
            color: var(--text);
            font-size: 0.75rem;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: all 0.15s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%2392278F' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 8px center;
            padding-left: 24px;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(146, 39, 143, 0.15);
        }

        .actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 10px 10px;
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.35rem 0.6rem;
            border-radius: var(--r-sm);
            border: 1px solid var(--border-strong);
            background: var(--chip);
            font-weight: 600;
            font-size: 0.68rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s ease;
            color: var(--text);
        }

        .toggle:hover {
            background: var(--surface-solid);
            border-color: var(--accent);
        }

        .toggle:active {
            transform: scale(0.98);
        }

        .toggle[aria-pressed="true"] {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .count {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--r-sm);
            background: var(--chip);
            font-weight: 700;
            font-size: 0.68rem;
            white-space: nowrap;
            color: var(--text-secondary);
        }

        .count span {
            color: var(--accent);
            font-weight: 800;
        }

        /* Export button - Professional style */
        .export-btn {
            height: 28px !important;
            min-height: 28px !important;
            padding: 0 10px;
            border-radius: var(--r-sm);
            font-size: 0.7rem;
            background: var(--highlight);
            color: #333;
            border: 1px solid var(--border-strong);
            font-weight: 700;
            box-shadow: var(--shadow-sm);
            transition: all 0.15s ease;
        }

        .export-btn:hover {
            background: #f0c000;
            box-shadow: var(--shadow-md);
        }

        /* Table - Clean styling */
        .table-container {
            padding: 10px;
        }

        .tablewrap {
            max-height: calc(100vh - 360px);
            overflow: auto;
            border-radius: var(--r-sm);
            background: var(--surface-solid);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .tablewrap::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .tablewrap::-webkit-scrollbar-thumb {
            background: var(--accent-dark);
            border-radius: 999px;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.72rem;
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8f8f8;
            color: var(--text);
            white-space: nowrap;
            padding: 10px 8px;
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            border-bottom: 2px solid var(--accent);
            text-align: right;
        }

        th,
        td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            vertical-align: middle;
        }

        tbody tr {
            transition: background 0.15s ease;
        }

        tbody tr:hover {
            background: #f9f0fa;
        }

        /* selected row highlight */
        tbody tr.selected-row {
            background: #f3e5f5 !important;
        }

        textarea {
            width: 100%;
            min-height: 40px;
            resize: vertical;
            padding: 6px;
            border-radius: var(--r-sm);
            border: 1px solid var(--border-strong);
            background: var(--surface-solid);
            color: var(--text);
            font-size: 0.75rem;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea[readonly] {
            opacity: 0.6;
            background: var(--chip);
            cursor: not-allowed;
        }

        .solved-cell {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-wrap: nowrap;
        }

        .solved-cell .pill {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: var(--r-sm);
            font-size: 0.65rem;
            font-weight: 700;
            background: var(--chip);
            color: var(--muted);
            border: 1px solid var(--border);
        }

        .solved-cell .pill.ok {
            background: var(--ok-light);
            color: var(--ok);
            border-color: transparent;
        }

        #measure {
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            top: -9999px;
            left: -9999px;
            font: inherit;
            padding: 12px 10px;
        }

        /* Modals - Clean geometric style */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 20px;
            width: 100%;
            max-width: 360px;
            box-shadow: var(--shadow-lg);
        }

        .modal .btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            border: 1px solid var(--border-strong);
            border-radius: var(--r-sm);
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-weight: 700;
            background: var(--chip);
            font-size: 0.8rem;
            flex: 1;
            transition: all 0.15s ease;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background: var(--surface-solid);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.primary {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
        }

        .btn.primary:hover {
            box-shadow: var(--shadow-md);
        }

        .login-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 16px;
        }

        .login {
            background: var(--surface);
            -webkit-backdrop-filter: var(--blur);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 28px;
            width: 100%;
            max-width: 380px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .login h3 {
            margin: 0 0 16px;
            font-size: 1.35rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login .row {
            display: grid;
            gap: 8px;
            margin: 14px 0;
        }

        .login input {
            height: 48px;
            border: 1px solid var(--border-strong);
            border-radius: var(--r-sm);
            padding: 0 16px;
            background: var(--surface-solid);
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .login input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .login .hint {
            color: var(--muted);
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .login .error {
            color: var(--danger);
            min-height: 1.2em;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .footer-note {
            padding: 12px 16px;
            font-size: 0.75rem;
            color: var(--muted);
            text-align: center;
            border-top: 1px solid var(--border);
        }

        /* Improve touch targets */
        button,
        select,
        input[type="checkbox"],
        .linkish {
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .toggle,
        .count {
            min-height: 40px;
        }

        .tel-link {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .loc-btn {
            padding: 8px 16px;
            font-size: 0.8rem;
            border-radius: var(--r-sm);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 38px;
            justify-content: center;
            border: none;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .loc-btn.has-data {
            background: var(--ok-light);
            color: var(--ok);
        }

        .loc-btn.no-data {
            background: var(--danger-light);
            color: var(--danger);
        }

        .loc-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .loc-btn:active {
            transform: scale(0.97);
        }

        /* Loading animation */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <header>
        <div class="userbar">
            <div style="flex:1">
                <h1>‚ú® New Requests Portal</h1>
                <div class="muted">Seamless Workflow</div>
            </div>
            <div class="userpill">
                <span id="user-badge">üö´ Not logged in</span>
                <span id="auth-toggle" class="linkish" title="Sign In">Sign In</span>
            </div>
        </div>
    </header>

    <main>
        <section class="card filters-card">
            <div class="filters">
                <label>exch <select id="f-exch">
                        <option value="">ÿßŸÑŸÉŸÑ</option>
                    </select></label>
                <label>msan <select id="f-msan">
                        <option value="">ÿßŸÑŸÉŸÑ</option>
                    </select></label>
                <label>cabinet <select id="f-cabinet">
                        <option value="">ÿßŸÑŸÉŸÑ</option>
                    </select></label>
                <label>dp <select id="f-dp">
                        <option value="">ÿßŸÑŸÉŸÑ</option>
                    </select></label>
                <label>group <select id="f-group">
                        <option value="">ÿßŸÑŸÉŸÑ</option>
                    </select></label>
                <button id="btn-export" class="toggle export-btn" type="button" title="ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ÿØŸàŸÑ ŸÉŸÖŸÑŸÅ PDF">üìÑ ÿ™ÿµÿØŸäÿ±
                    PDF</button>
            </div>
            <div class="actions">
                <button id="btn-solved-only" class="toggle" aria-pressed="false">üëÅÔ∏è ÿßŸÑŸÖÿ≠ŸÑŸàŸÑÿ© ŸÅŸÇÿ∑</button>
                <button id="btn-unsolved-only" class="toggle" aria-pressed="false">üëÅÔ∏è ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑŸàŸÑÿ©</button>
                <span class="count">ÿßŸÑŸÉŸÑ: <span id="count-total">0</span></span>
                <span class="count">ŸÖŸÜÿ¨ÿ≤: <span id="count-solved">0</span></span>
            </div>
            <div class="muted" style="padding:0 10px 10px;font-size:0.65rem;color:var(--text-secondary);" id="stat">
            </div>
        </section>

        <section class="card">
            <div class="table-container">
                <div class="tablewrap" id="tablewrap">
                    <table id="tbl">
                        <colgroup id="colgroup"></colgroup>
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="footer-note">ÿ•ŸÜ ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿÆŸàŸÑŸãÿß ÿ≥ÿ™ÿ∏Ÿáÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®Ÿàÿ∂ÿπ <b>ŸÇÿ±ÿßÿ°ÿ© ŸÅŸÇÿ∑</b>.</div>
        </section>
    </main>

    <div id="measure"></div>

    <!-- Confirm modal -->
    <div class="modal-backdrop" id="confirm-backdrop" aria-hidden="true">
        <div class="modal">
            <p id="confirm-text" style="margin:0 0 10px;font-size:.9rem">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü</p>
            <div class="btns">
                <button class="btn primary" id="confirm-yes">ŸÜÿπŸÖ</button>
                <button class="btn" id="confirm-no">ŸÑÿß</button>
            </div>
        </div>
    </div>

    <!-- Location modal -->
    <div class="modal-backdrop" id="loc-backdrop">
        <div class="modal">
            <h3 style="margin-top:0">ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ</h3>
            <div id="loc-status" style="font-size:.85rem; margin-bottom:10px">ÿ¨ÿßÿ±Ÿä ÿ¨ŸÑÿ® ÿßŸÑÿßÿ≠ÿØÿßÿ´Ÿäÿßÿ™...</div>

            <!-- Map Container -->
            <div id="map"
                style="height: 250px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border); background: var(--chip); z-index: 1;">
            </div>

            <div id="loc-coords"
                style="font-family:monospace; background:var(--chip); padding:8px; border-radius:6px; margin-bottom:10px; display:none; text-align:center; font-weight:bold; font-size:1.1rem">
            </div>
            <div class="btns">
                <button class="btn primary" id="loc-save" style="display:none">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ</button>
                <button class="btn" id="loc-refresh">ÿ™ÿ≠ÿØŸäÿ´</button>
                <button class="btn" id="loc-cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
            </div>
        </div>
    </div>

    <!-- Login modal -->
    <div class="login-backdrop" id="login-backdrop">
        <div class="login">
            <h3>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h3>
            <div class="hint">ÿ£ÿØŸàÿßÿ±: <b>Team Leader</b> ŸÑŸÑÿ™ÿ≠ÿ±Ÿäÿ± ‚Äî <b>Closer</b> ŸÑŸÑÿ∫ŸÑŸÇ ŸÅŸÇÿ∑.</div>
            <div class="row">
                <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                <input id="lg-user" autocomplete="username" />
            </div>
            <div class="row">
                <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                <input id="lg-pass" type="password" autocomplete="current-password" />
            </div>
            <div class="error" id="lg-error"></div>
            <div class="btns">
                <button class="btn primary" id="lg-ok">ÿØÿÆŸàŸÑ</button>
                <button class="btn" id="lg-cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
            </div>
            <div class="hint" style="margin-top:8px">ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ©ÿå ÿ≥ÿ™ÿØÿÆŸÑ ÿ®Ÿàÿ∂ÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÅŸÇÿ∑.</div>
        </div>
    </div>

    <!-- Map and Canvas libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        /* ===== CONFIG ===== */
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwz0fUdIq3O1eFgK0qdiDntNzEu_6GfBl1rg0Sgm2DwfWx43XtYJCoJdwZLqIfCwX5eJQ/exec';
        const FILE_ID = '1TBqg-sRUFKAuWdJLUb0biXL8EYThW9Eg';
        const API_KEY = '';
        const UI_TZ = 'Africa/Cairo';

        /* ===== SIMPLE AUTH with ROLES ===== */
        const AUTH_USERS = [
            { u: 'admin', p: '1234', role: 'admin' },
            { u: 'closer', p: 'close123', role: 'closer' },
            { u: 'south', p: 's123', role: 'group' },
            { u: 'middle', p: 'm123', role: 'group' },
            { u: 'north', p: 'n123', role: 'group' },
            { u: 'group1', p: 'g123', role: 'group' },
            { u: 'waleed', p: 'w123', role: 'team_leader' },
            { u: 'nasr', p: 'n123', role: 'team_leader' },
            { u: 'ahmed', p: 'a123', role: 'team_leader' }
        ];
        const SESSION_KEY = 'reqs_login_user_v2';
        const TEAM_LEADER_EDITABLE_COLS = ['notes', 'msan', 'cabinet', 'dp', 'type'];

        /* ===== Utils ===== */
        const Q = (s, el = document) => el.querySelector(s);
        const QQ = (s, el = document) => Array.from(el.querySelectorAll(s));
        const val = (r, k) => {
            if (!r) return '';
            const lk = String(k).toLowerCase().trim();
            // Try lowercase variant first (as we normalize rows to lowercase keys)
            if (r[lk] !== undefined) return (r[lk] ?? '').toString().trim();
            // Fallback to exact key if normalization failed
            return (r[k] ?? '').toString().trim();
        };

        function toast(message, ms = 1800) {
            const t = document.createElement('div');
            t.textContent = message;
            Object.assign(t.style, {
                position: 'fixed', left: '50%', transform: 'translateX(-50%)',
                bottom: '20px', zIndex: '2147483647',
                background: 'var(--surface)', color: 'var(--text)',
                border: '1px solid var(--border)', padding: '.6rem .9rem',
                borderRadius: '8px', boxShadow: '0 8px 22px rgba(0,0,0,.18)',
                fontWeight: '700', pointerEvents: 'none', fontSize: '.85rem',
                opacity: '0', transition: 'opacity .18s ease',
            });
            document.body.appendChild(t);
            requestAnimationFrame(() => { t.style.opacity = '1'; });
            setTimeout(() => { t.style.opacity = '0'; }, Math.max(250, ms - 200));
            setTimeout(() => { t.remove(); }, ms + 50);
        }

        function askConfirm(text) {
            return new Promise(resolve => {
                const bd = Q('#confirm-backdrop');
                const yes = Q('#confirm-yes'), no = Q('#confirm-no'), p = Q('#confirm-text');
                p.textContent = text;
                bd.style.display = 'flex';
                function cleanup() { bd.style.display = 'none'; yes.onclick = no.onclick = bd.onclick = null; }
                yes.onclick = () => { cleanup(); resolve(true); };
                no.onclick = () => { cleanup(); resolve(false); };
                bd.onclick = (e) => { if (e.target === bd) { cleanup(); resolve(false); } };
            });
        }

        function nowStampCairo() {
            const d = new Date();
            const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: UI_TZ, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const parts = Object.fromEntries(fmt.formatToParts(d).map(p => [p.type, p.value]));
            return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second}`;
        }

        // ---- CSV helpers ----
        function parseCSV(csvText) {
            const rows = []; let i = 0, field = '', row = [], inQ = false;
            while (i < csvText.length) {
                const c = csvText[i];
                if (inQ) { if (c === '"') { if (csvText[i + 1] === '"') { field += '"'; i++; } else inQ = false; } else field += c; }
                else {
                    if (c === '"') inQ = true; else if (c === ',') { row.push(field); field = ''; }
                    else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
                    else if (c !== '\r') { field += c; }
                }
                i++;
            }
            if (field.length || row.length) { row.push(field); rows.push(row); }
            const headers = rows.shift() || [];
            return rows.map(r => { const o = {}; headers.forEach((h, idx) => o[h] = r[idx] ?? ''); return o; });
        }
        function toCSV(rows, headerOrder) {
            const esc = v => { let s = v == null ? '' : String(v); if (s.includes('"')) s = s.replace(/"/g, '""'); if (/[",\n\r]/.test(s)) s = `"${s}"`; return s; };
            const headers = headerOrder || Object.keys(rows[0] || {});
            const lines = [headers.map(esc).join(',')];
            for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(','));
            return lines.join('\n');
        }
        async function readFromDrive(id) {
            const url = `${APPS_SCRIPT_URL}?id=${encodeURIComponent(id)}`;
            console.log('Fetching from URL:', url);
            let resp;
            try {
                resp = await fetch(url, { cache: 'no-store' });
            } catch (networkError) {
                console.error('Fetch network error:', networkError);
                throw new Error('Network error (Failed to fetch). Check Script URL and permissions.');
            }

            if (!resp.ok) throw new Error('Failed to fetch from script: HTTP ' + resp.status);

            const text = await resp.text();

            // Check for HTML error page
            if (text.startsWith('<!doctype') || text.startsWith('<html')) {
                throw new Error('Script returned HTML (Login page). Check "Who has access: Anyone" in deployment.');
            }

            // Check for error response
            if (text.startsWith('ERROR')) {
                throw new Error('Apps Script Error: ' + text);
            }

            // Parse CSV text directly
            return parseCSV(text);
        }
        async function writeToDrive(id, csvText) {
            const url = `${APPS_SCRIPT_URL}?id=${encodeURIComponent(id)}&op=overwrite${API_KEY ? '&key=' + encodeURIComponent(API_KEY) : ''}`;
            const resp = await fetch(url, {
                method: 'POST',
                body: csvText
            });

            const t = await resp.text();
            if (!resp.ok || (t && t.startsWith('ERROR'))) throw new Error(t || ('HTTP ' + resp.status));
            return true;
        }
        function normalizeKey(k) {
            let nk = String(k || '').trim().toLowerCase();
            if (nk === 'msan ') nk = 'msan';
            if (nk === 'solved by') nk = 'solved_by';
            if (nk === 'team leader') nk = 'team_leader';
            return nk;
        }
        function normalizeRowKeys(r) {
            const o = {};
            for (const k of Object.keys(r)) {
                o[normalizeKey(k)] = r[k];
            }
            return o;
        }

        /* ===== State ===== */
        let rows = [], headerOrder = [];
        let filtered = [], displayed = [];
        let viewMode = 'all';
        let currentUser = null;
        let canEdit = false;
        let canClose = false;
        let isTeamLeader = false;
        let isGroup = false;
        let selectedRowEl = null;
        let activeLocRow = null;
        let activeLocCol = null;
        let leafletMap = null;
        let leafletUserMarker = null;
        let leafletTargetMarker = null;
        let locViewMode = false;

        /* ===== Filtering / rendering ===== */
        const FILTER_KEYS = ['exch', 'msan', 'cabinet', 'dp', 'group'];

        function matches(r, s) {
            if (!s) return true;
            const m = (k, v) => {
                const query = (v || '').toString().trim().toLowerCase();
                if (!query || query === 'ÿßŸÑŸÉŸÑ') return true;
                const rowVal = val(r, k).toLowerCase();
                return rowVal === query;
            };
            return m('exch', s.exch) && m('msan', s.msan) && m('cabinet', s.cabinet) && m('dp', s.dp) && m('group', s.group);
        }

        function optionsFor(col, scope) {
            const set = new Set(rows.filter(r => matches(r, scope)).map(r => val(r, col)).filter(Boolean));
            return ['', ...Array.from(set).sort((a, b) => a.localeCompare(b, 'ar'))];
        }

        function currentSelection() {
            return {
                exch: Q('#f-exch').value.trim(),
                msan: Q('#f-msan').value.trim(),
                cabinet: Q('#f-cabinet').value.trim(),
                dp: Q('#f-dp').value.trim(),
                group: Q('#f-group').value.trim()
            };
        }

        function setSelectOptions(selEl, options, keepValue) {
            const prev = keepValue ?? selEl.value;
            selEl.innerHTML = options.map(v => `<option value="${v}">${v || 'ÿßŸÑŸÉŸÑ'}</option>`).join('');
            selEl.value = options.includes(prev) ? prev : '';
        }

        function refreshFiltersOnly() {
            const s = currentSelection();
            FILTER_KEYS.forEach(key => {
                const scope = { ...s, [key]: '' };
                const opts = optionsFor(key, scope);
                const selEl = Q('#f-' + key);
                setSelectOptions(selEl, opts, s[key]);
                s[key] = selEl.value.trim();
            });
        }

        function refreshFiltersAndTable() {
            refreshFiltersOnly();
            const s = currentSelection();

            // Filter based on dropdowns
            filtered = rows.filter(r => matches(r, s));

            const isAdmin = currentUser && currentUser.role === 'admin';

            // Row-level Security
            if (currentUser && !isAdmin) {
                const u = (currentUser.u || '').toLowerCase().trim();
                if (isTeamLeader) {
                    filtered = filtered.filter(r => {
                        const tl = val(r, 'team_leader').toLowerCase().trim();
                        return tl === u || tl.includes(u);
                    });
                }
                // Group role now sees all rows (No filter)
            }

            // Sort by service number date (first 6 chars = YYMMDD), newest first
            filtered.sort((a, b) => {
                const snA = val(a, 'service no') || '';
                const snB = val(b, 'service no') || '';

                // Extract first 6 characters (YYMMDD)
                const dateStrA = snA.substring(0, 6);
                const dateStrB = snB.substring(0, 6);

                // Parse YYMMDD to comparable number (higher = newer)
                // Format: YY MM DD -> convert to YYYYMMDD for comparison
                const parseDate = (s) => {
                    if (s.length < 6) return 0;
                    const yy = parseInt(s.substring(0, 2), 10);
                    const mm = parseInt(s.substring(2, 4), 10);
                    const dd = parseInt(s.substring(4, 6), 10);
                    // Assume 20xx for years (2000-2099)
                    const yyyy = 2000 + yy;
                    return yyyy * 10000 + mm * 100 + dd;
                };

                const dateA = parseDate(dateStrA);
                const dateB = parseDate(dateStrB);

                // Sort descending (newest first)
                return dateB - dateA;
            });

            applyViewMode();
            renderTable(displayed);
            updateCounters();
            Q('#stat').textContent = `ÿπÿØÿØ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨: ${displayed.length}`;
        }

        function applyViewMode() {
            if (viewMode === 'solved') displayed = filtered.filter(r => val(r, 'solved').toLowerCase() === 'ok');
            else if (viewMode === 'unsolved') displayed = filtered.filter(r => val(r, 'solved').toLowerCase() !== 'ok');
            else displayed = filtered.slice();
            updateViewButtons();
        }
        function updateViewButtons() {
            const btnS = Q('#btn-solved-only'), btnU = Q('#btn-unsolved-only');
            btnS.setAttribute('aria-pressed', viewMode === 'solved'); btnU.setAttribute('aria-pressed', viewMode === 'unsolved');
            btnS.textContent = viewMode === 'solved' ? '‚Ü©Ô∏è ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ' : 'üëÅÔ∏è ÿßŸÑŸÖÿ≠ŸÑŸàŸÑÿ© ŸÅŸÇÿ∑';
            btnU.textContent = viewMode === 'unsolved' ? '‚Ü©Ô∏è ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ' : 'üëÅÔ∏è ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑŸàŸÑÿ©';
        }
        function setViewMode(newMode) { viewMode = (viewMode === newMode) ? 'all' : newMode; refreshFiltersAndTable(); }

        function updateCounters() {
            Q('#count-total').textContent = filtered.length;
            Q('#count-solved').textContent = filtered.filter(r => val(r, 'solved').toLowerCase() === 'ok').length;
        }

        function ensureColumnsOrder(baseCols) {
            let cols = baseCols.slice();

            const extra = [
                'customer loc', 'dp loc',
                'customer loc lat', 'customer loc long',
                'dp loc lat', 'dp loc long',
                'comment', 'solved', 'solved_at', 'solved_by', 'closed', 'team_leader'
            ];

            // Add missing columns (case-insensitive check)
            extra.forEach(k => {
                if (!cols.some(c => c.toLowerCase().trim() === k)) {
                    cols.push(k);
                }
            });

            const move = (arr, fromKey, toIndex) => {
                const i = arr.findIndex(c => String(c).toLowerCase().trim() === fromKey);
                if (i > -1 && i !== toIndex) { const [x] = arr.splice(i, 1); arr.splice(Math.min(toIndex, arr.length), 0, x); }
            };

            const typeIdx = cols.findIndex(c => String(c).toLowerCase().trim() === 'type');
            if (typeIdx > -1) {
                const startIdx = typeIdx + 1;
                move(cols, 'dp loc lat', startIdx);
                move(cols, 'dp loc long', startIdx + 1);
                move(cols, 'dp loc', startIdx + 2);
                move(cols, 'customer loc lat', startIdx + 3);
                move(cols, 'customer loc long', startIdx + 4);
                move(cols, 'customer loc', startIdx + 5);
            }

            const idxSolved = cols.findIndex(c => String(c).toLowerCase().trim() === 'solved');
            if (idxSolved > -1) {
                move(cols, 'solved_at', idxSolved + 1);
                move(cols, 'solved_by', idxSolved + 2);
                move(cols, 'closed', idxSolved + 3);
            }

            // Hide internal coordinate columns from the visible array used for table rendering
            const hidden = ['customer loc lat', 'customer loc long', 'dp loc lat', 'dp loc long'];
            return cols.filter(c => !hidden.includes(c.toLowerCase().trim()));
        }

        function renderTable(rowsToShow) {
            const thead = Q('#tbl thead'), tbody = Q('#tbl tbody');
            const baseCols = headerOrder.map(h => (h.trim() === 'msan' || h.trim() === 'msan ') ? 'msan' : h.trim());
            const cols = ensureColumnsOrder(baseCols);
            thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';

            const rowHtml = r => cols.map(c => {
                const lc = String(c).toLowerCase().trim();
                if (lc === 'comment') {
                    const v = r[lc] ?? val(r, c);
                    const ro = (canEdit || isGroup) ? '' : 'readonly';
                    return `<td><textarea data-id="${r.__id}" data-col="${lc}" ${ro}>${(v + '').replace(/</g, '&lt;')}</textarea></td>`;
                } else if (TEAM_LEADER_EDITABLE_COLS.includes(lc)) {
                    const v = r[lc] ?? val(r, c);
                    const isAdmin = currentUser && (currentUser.u === 'admin' || currentUser.isAdmin === true);
                    const ro = (canEdit || isAdmin) ? '' : 'readonly';
                    return `<td><input type="text" value="${(v + '').replace(/"/g, '&quot;')}" data-id="${r.__id}" data-col="${lc}" ${ro} style="width:100%; border:none; background:transparent; font-size:inherit; color:inherit; padding:2px;"></td>`;
                } else if (lc === 'solved') {
                    const isOk = val(r, 'solved').toLowerCase() === 'ok';
                    const pill = isOk ? `<span class="pill ok">ok</span>` : `<span class="pill">‚Äî</span>`;
                    const ro = (canEdit || isGroup);
                    const dis = ro ? '' : 'disabled';
                    const tt = ro ? 'ÿ™ÿ®ÿØŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ŸÑ' : 'ÿ∫Ÿäÿ± ŸÖÿÆŸàŸÑ (Team Leader/Group ŸÅŸÇÿ∑)';
                    return `<td>
                  <div class="solved-cell">
                    <input type="checkbox" data-id="${r.__id}" data-col="solved" ${isOk ? 'checked' : ''} ${dis} title="${tt}" style="width:18px;height:18px;accent-color:var(--accent);">
                    ${pill}
                  </div>
                </td>`;
                } else if (lc === 'closed') {
                    const isClosed = ['yes', 'ok', '1', 'true'].includes(val(r, 'closed').toLowerCase());
                    const dis = canClose ? '' : 'disabled';
                    const tt = canClose ? 'ÿ™ÿ®ÿØŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∫ŸÑŸÇ' : 'ÿ∫Ÿäÿ± ŸÖÿÆŸàŸÑ (Closer ŸÅŸÇÿ∑)';
                    return `<td>
                  <div class="solved-cell">
                    <input type="checkbox" data-id="${r.__id}" data-col="closed" ${isClosed ? 'checked' : ''} ${dis} title="${tt}" style="width:18px;height:18px;accent-color:var(--accent);">
                    <span class="pill">${isClosed ? 'yes' : '‚Äî'}</span>
                  </div>
                </td>`;
                } else if (lc === 'customer loc' || lc === 'dp loc') {
                    const lat = val(r, lc + ' lat'), long = val(r, lc + ' long');
                    const hasData = lat && long;
                    const label = hasData ? 'ÿßŸÑŸÖŸàŸÇÿπ' : (val(r, lc) || 'ÿ™ÿ≠ÿØŸäÿØ');
                    const btnClass = hasData ? 'has-data' : 'no-data';
                    return `<td>
                  <div style="display:flex; align-items:center; gap:4px; justify-content:center;">
                    <button class="loc-btn ${btnClass}" data-id="${r.__id}" data-col="${lc}" title="ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ">
                      üìç ${label}
                    </button>
                  </div>
                </td>`;
                } else if (['customer loc lat', 'customer loc long', 'dp loc lat', 'dp loc long'].includes(lc)) {
                    return `<td style="opacity:0.5; font-size:0.65rem;">${val(r, c)}</td>`;
                } else {
                    const v = val(r, c);
                    if (lc === 'mob') {
                        const clean = v.replace(/\s+/g, '');
                        return `<td>${v ? `<a class="tel-link" href="tel:${clean}">${v}</a>` : ''}</td>`;
                    }
                    return `<td>${v}</td>`;
                }
            }).join('');
            tbody.innerHTML = rowsToShow.map(r => `<tr>${rowHtml(r)}</tr>`).join('');

            autoFitColumns(cols, rowsToShow);

            selectedRowEl = null;
            QQ('#tbl tbody tr').forEach(tr => {
                tr.addEventListener('click', () => {
                    if (selectedRowEl && selectedRowEl !== tr) {
                        selectedRowEl.classList.remove('selected-row');
                    }
                    selectedRowEl = tr;
                    selectedRowEl.classList.add('selected-row');
                });
            });

            if (canEdit || isGroup) {
                QQ('textarea[data-id], input[data-col][data-id]').forEach(inp => {
                    const id = inp.getAttribute('data-id');
                    const col = inp.getAttribute('data-col');
                    if (col === 'solved' || col === 'closed') return; // Handled separately
                    const row = rows.find(x => x.__id === id);
                    const orig = row ? (row[col] ?? '') : '';

                    inp.addEventListener('blur', async () => {
                        const v = inp.value; if (v === orig) return;

                        // Restriction: Group can only edit comment
                        if (isGroup && col !== 'comment') {
                            inp.value = orig;
                            toast('üö´ ÿ∫Ÿäÿ± ŸÖÿÆŸàŸÑ ÿ®ÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ≠ŸÇŸÑ');
                            return;
                        }

                        const msg = col === 'comment' ? 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ Ÿáÿ∞ÿß ÿßŸÑÿ™ÿπŸÑŸäŸÇÿü' : `ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÅŸä ÿßŸÑÿπŸÖŸàÿØ (${col})ÿü`;
                        const ok = await askConfirm(msg);
                        if (!ok) { inp.value = orig; return; }
                        row[col] = v;
                        try { await saveAll(); toast('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπŸÑŸäŸÇ'); refreshFiltersAndTable(); }
                        catch (e) { alert('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + (e && e.message ? e.message : e)); }
                    });
                });

                QQ('td .solved-cell input[type="checkbox"][data-col="solved"]').forEach(chk => {
                    chk.addEventListener('change', async () => {
                        const id = chk.getAttribute('data-id');
                        const row = rows.find(x => x.__id === id);
                        const wasChecked = (val(row, 'solved').toLowerCase() === 'ok');
                        const isChecked = chk.checked;

                        // Check if Group has permission
                        if (!canEdit && !isGroup) {
                            chk.checked = wasChecked;
                            toast('üö´ ÿ∫Ÿäÿ± ŸÖÿÆŸàŸÑ');
                            return;
                        }

                        const msg = isChecked ? 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© (ÿ™ŸÖ ÿßŸÑÿ≠ŸÑ)ÿü' : 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© (ÿ™ŸÖ ÿßŸÑÿ≠ŸÑ)ÿü';
                        const ok = await askConfirm(msg);
                        if (!ok) { chk.checked = wasChecked; return; }
                        if (isChecked) {
                            row.solved = 'ok';
                            row.solved_at = nowStampCairo();
                            if (currentUser && currentUser.u) row.solved_by = currentUser.u;
                        } else {
                            row.solved = '';
                            row.solved_at = '';
                            row.solved_by = '';
                        }
                        try { await saveAll(); toast(isChecked ? '‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´' : '‚Ü©Ô∏è ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°'); refreshFiltersAndTable(); }
                        catch (e) { chk.checked = wasChecked; alert('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + (e && e.message ? e.message : e)); }
                    });
                });
            }

            if (canClose) {
                QQ('td .solved-cell input[type="checkbox"][data-col="closed"]').forEach(chk => {
                    chk.addEventListener('change', async () => {
                        const id = chk.getAttribute('data-id');
                        const row = rows.find(x => x.__id === id);
                        const wasChecked = ['yes', 'ok', '1', 'true'].includes(val(row, 'closed').toLowerCase());
                        const isChecked = chk.checked;
                        const msg = isChecked ? 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© (ŸÖÿ∫ŸÑŸÇ)ÿü' : 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© (ŸÖÿ∫ŸÑŸÇ)ÿü';
                        const ok = await askConfirm(msg);
                        if (!ok) { chk.checked = wasChecked; return; }
                        row.closed = isChecked ? 'yes' : '';
                        try { await saveAll(); toast(isChecked ? '‚úÖ ÿ™ŸÖ ÿßŸÑÿ∫ŸÑŸÇ' : '‚Ü©Ô∏è ÿ™ŸÖ ÿßŸÑŸÅÿ™ÿ≠'); refreshFiltersAndTable(); }
                        catch (e) { chk.checked = wasChecked; alert('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + (e && e.message ? e.message : e)); }
                    });
                });
            }

            if (canEdit || canClose || isGroup) {
                QQ('.loc-btn[data-id]').forEach(btn => {
                    const hasData = btn.classList.contains('has-data');
                    // Group users can ONLY click if there is data. Tech/Closer can click anytime.
                    const clickable = (canEdit || canClose) || (isGroup && hasData);

                    if (clickable) {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = btn.getAttribute('data-id');
                            const col = btn.getAttribute('data-col');
                            const row = rows.find(x => x.__id === id);
                            showLocModal(row, col);
                        });
                    } else {
                        btn.style.cursor = 'default';
                        btn.title = 'ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
                    }
                });
            }
        }

        function showLocModal(row, col) {
            activeLocRow = row;
            activeLocCol = col;

            const lat = val(row, col + ' lat'), lng = val(row, col + ' long');
            const hasData = lat && lng;
            locViewMode = (isGroup && hasData);

            Q('#loc-backdrop').style.display = 'flex';
            Q('#loc-save').style.display = locViewMode ? 'none' : 'none'; // Initially hidden
            Q('#loc-refresh').textContent = locViewMode ? 'ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπŸä' : 'ÿ™ÿ≠ÿØŸäÿ´';
            Q('#loc-cancel').textContent = locViewMode ? 'ÿ•ÿ∫ŸÑÿßŸÇ' : 'ÿ•ŸÑÿ∫ÿßÿ°';
            Q('h3', Q('#loc-backdrop')).textContent = locViewMode ? 'ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàŸÇÿπ' : 'ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';

            // Initialize or Resize Map
            if (!leafletMap) {
                leafletMap = L.map('map').setView([24.0, 32.8], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(leafletMap);
            } else {
                setTimeout(() => leafletMap.invalidateSize(), 100);
            }

            // Target Marker (Red)
            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            if (hasData) {
                const targetPos = [parseFloat(lat), parseFloat(lng)];
                if (!leafletTargetMarker) {
                    leafletTargetMarker = L.marker(targetPos, { icon: redIcon }).addTo(leafletMap).bindPopup('ÿßŸÑŸÖŸÉÿßŸÜ ÿßŸÑŸÖÿÆÿ≤ŸÜ');
                } else {
                    leafletTargetMarker.setLatLng(targetPos).addTo(leafletMap);
                }
            } else {
                if (leafletTargetMarker) leafletMap.removeLayer(leafletTargetMarker);
            }

            fetchLocation();
        }

        function fetchLocation() {
            const status = Q('#loc-status');
            const coordsDiv = Q('#loc-coords');
            const saveBtn = Q('#loc-save');

            status.innerHTML = 'ÿ¨ÿßÿ±Ÿä ÿ¨ŸÑÿ® ÿßŸÑÿßÿ≠ÿØÿßÿ´Ÿäÿßÿ™...';
            coordsDiv.style.display = 'none';
            saveBtn.style.display = 'none';

            if (!navigator.geolocation) {
                status.textContent = 'ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ.';
                return;
            }

            // Check for secure context (HTTPS requirement for mobile)
            const isSecure = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost';

            if (!isSecure) {
                status.innerHTML = `<div style="color:var(--danger); line-height:1.4;">
                    ‚ö†Ô∏è ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ Ÿäÿ™ÿ∑ŸÑÿ® ÿßÿ™ÿµÿßŸÑ ÿ¢ŸÖŸÜ (HTTPS).<br>
                    <small>Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÄ Web App ÿßŸÑŸÖŸàÿ¨Ÿá ŸÖŸÜ Google Apps Script ŸÑŸäÿπŸÖŸÑ ÿßŸÑŸÄ GPS ÿπŸÑŸâ ÿßŸÑŸáÿßÿ™ŸÅ.</small>
                </div>`;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    const latlng = [parseFloat(lat), parseFloat(lng)];

                    coordsDiv.textContent = `${lat}, ${lng}`;
                    coordsDiv.style.display = 'block';
                    status.textContent = 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠:';
                    saveBtn.style.display = locViewMode ? 'none' : 'inline-block';

                    // Update User Marker (Blue)
                    if (leafletMap) {
                        if (!leafletUserMarker) {
                            leafletUserMarker = L.marker(latlng).addTo(leafletMap).bindPopup('ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä');
                        } else {
                            leafletUserMarker.setLatLng(latlng).addTo(leafletMap);
                        }

                        if (locViewMode && leafletTargetMarker) {
                            const group = new L.featureGroup([leafletUserMarker, leafletTargetMarker]);
                            leafletMap.fitBounds(group.getBounds().pad(0.2));
                        } else {
                            leafletMap.setView(latlng, 16);
                        }
                    }
                },
                (err) => {
                    console.error('Geolocation error:', err);
                    let msg = 'ÿ™ÿπÿ∞ÿ± ÿ¨ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ.';
                    if (err.code === 1) msg = 'üö´ ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ•ÿ∞ŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ. Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑŸá ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.';
                    else if (err.code === 2) msg = '‚ùå ŸÖŸàŸÇÿπ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ÿ≠ÿßŸÑŸäÿßŸã.';
                    else if (err.code === 3) msg = '‚è≥ ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ.';
                    status.innerHTML = `<span style="color:var(--danger)">${msg}</span>`;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function autoFitColumns(cols, rowsToShow) {
            const meas = Q('#measure'); const colgroup = Q('#colgroup'); colgroup.innerHTML = '';
            const wide = new Set(['address', 'notes', 'name', 'comment', 'solved_at', 'solved_by']);
            const sampleN = Math.min(rowsToShow.length, 80);
            cols.forEach((c) => {
                meas.style.whiteSpace = 'nowrap'; meas.textContent = c; let w = meas.offsetWidth;
                for (let i = 0; i < sampleN; i++) {
                    const r = rowsToShow[i];
                    const txt = (r && r[c] != null) ? String(r[c]) : '';
                    meas.textContent = txt;
                    w = Math.max(w, meas.offsetWidth);
                }
                w += 16;
                const minN = 60, maxN = 140, minW = 120, maxW = 400;
                const isW = wide.has(String(c).toLowerCase());
                const finalW = Math.max(isW ? minW : minN, Math.min(w, isW ? maxW : maxN));
                const col = document.createElement('col');
                col.style.minWidth = finalW + 'px';
                colgroup.appendChild(col);
            });
        }

        async function saveAll() {
            const headers = headerOrder.map(h => (h.trim() === 'msan' || h.trim() === 'msan ') ? 'msan' : h.trim());
            const extraCols = [
                'customer loc', 'dp loc', 'customer loc lat', 'customer loc long',
                'dp loc lat', 'dp loc long', 'solved', 'comment', 'solved_at', 'solved_by', 'closed'
            ];
            for (const k of extraCols) if (!headers.includes(k)) headers.push(k);
            const material = rows.map(r => { const o = {}; headers.forEach(h => o[h] = r[h] ?? ''); return o; });
            const csv = toCSV(material, headers);
            Q('#stat').textContent = 'Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏...';
            await writeToDrive(FILE_ID, csv);
            Q('#stat').textContent = 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ Google Drive';
        }

        // ===== EXPORT TO PDF: clone full table (all columns) =====
        async function exportTableAsPDF() {
            if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                alert('ŸÖŸÉÿ™ÿ®ÿßÿ™ ÿßŸÑÿ™ÿµÿØŸäÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.');
                return;
            }

            const srcTable = Q('#tbl');
            if (!srcTable) return;

            try {
                toast('üìÑ ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ PDF...');

                // Off-screen container
                const exportRoot = document.createElement('div');
                exportRoot.style.position = 'fixed';
                exportRoot.style.left = '-100000px';
                exportRoot.style.top = '0';
                exportRoot.style.background = '#ffffff';
                exportRoot.style.direction = 'rtl';

                // Clone the REAL table (no scroll wrapper)
                const tbl = srcTable.cloneNode(true);
                tbl.removeAttribute('id');
                tbl.style.borderCollapse = 'collapse';
                tbl.style.width = '100%';
                tbl.style.tableLayout = 'fixed';
                tbl.style.fontSize = '9px';

                const colCount = tbl.querySelectorAll('thead th').length || 10;
                const exportWidth = Math.max(1600, colCount * 110);
                exportRoot.style.width = exportWidth + 'px';

                // Equal column widths
                const colgroup = tbl.querySelector('colgroup');
                if (colgroup) {
                    const cols = colgroup.querySelectorAll('col');
                    const percent = (100 / (cols.length || colCount)).toFixed(2) + '%';
                    cols.forEach(c => {
                        c.style.minWidth = '0';
                        c.style.width = percent;
                    });
                }

                // Convert textareas to simple divs so full text appears
                tbl.querySelectorAll('textarea').forEach(t => {
                    const div = document.createElement('div');
                    div.textContent = t.value || t.textContent || '';
                    div.style.whiteSpace = 'pre-wrap';
                    div.style.wordWrap = 'break-word';
                    div.style.wordBreak = 'break-word';
                    t.parentNode.replaceChild(div, t);
                });

                // Reset sticky headers, borders, wrapping
                tbl.querySelectorAll('thead th').forEach(th => {
                    th.style.position = 'static';
                    th.style.background = '#f3f4f6';
                    th.style.border = '1px solid #d1d5db';
                    th.style.padding = '4px';
                    th.style.whiteSpace = 'normal';
                    th.style.wordWrap = 'break-word';
                    th.style.wordBreak = 'break-word';
                });
                tbl.querySelectorAll('td').forEach(td => {
                    td.style.border = '1px solid #e5e7eb';
                    td.style.padding = '4px';
                    td.style.background = '#ffffff';
                    td.style.whiteSpace = 'normal';
                    td.style.wordWrap = 'break-word';
                    td.style.wordBreak = 'break-word';
                });
                tbl.querySelectorAll('tr').forEach(tr => {
                    tr.style.backgroundColor = '#ffffff';
                });
                tbl.querySelectorAll('.solved-cell .pill').forEach(p => {
                    p.style.background = '#e5f2ff';
                    p.style.border = '1px solid #bfdbfe';
                    p.style.color = '#111827';
                });

                exportRoot.appendChild(tbl);
                document.body.appendChild(exportRoot);

                const canvas = await html2canvas(exportRoot, {
                    scale: 2,
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'pt', 'a4'); // landscape

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 24;
                const imgWidth = pageWidth - margin * 2;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                let position = margin;
                let heightLeft = imgHeight;

                pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - margin * 2);

                while (heightLeft > 0) {
                    pdf.addPage();
                    position = margin - (imgHeight - heightLeft);
                    pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - margin * 2);
                }

                const stamp = nowStampCairo().replace(/[: ]/g, '-');
                const filename = `requests-${stamp}.pdf`;
                pdf.save(filename);

                toast('‚úÖ ÿ™ŸÖ ÿ™ÿ¨ŸáŸäÿ≤ ŸÖŸÑŸÅ ÿßŸÑŸÄ PDF');
                exportRoot.remove();
            } catch (e) {
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ PDF.\n' + (e && e.message ? e.message : e));
            }
        }

        /* ===== Auth UI Update ===== */
        function updateAuthUI() {
            const badge = Q('#user-badge');
            const toggle = Q('#auth-toggle');
            if (currentUser) {
                const r = currentUser.role;
                canEdit = (r === 'admin' || r === 'team_leader');
                canClose = (r === 'admin' || r === 'closer');
                isTeamLeader = (r === 'team_leader');
                isGroup = (r === 'group');

                if (r === 'guest') badge.textContent = `üëÄ ${currentUser.u} (ŸÇÿ±ÿßÿ°ÿ© ŸÅŸÇÿ∑)`;
                else {
                    const label = (currentUser.u === r) ? currentUser.u : `${currentUser.u} (${r})`;
                    badge.textContent = `‚úÖ ${label}`;
                }
                toggle.textContent = 'Sign Out';
                toggle.title = 'Sign Out';
            } else {
                canEdit = false; canClose = false; isTeamLeader = false; isGroup = false;
                badge.textContent = 'üö´ Not logged in';
                toggle.textContent = 'Sign In';
                toggle.title = 'Sign In';
            }
        }

        /* ===== Init ===== */
        (async function () {
            try { const s = localStorage.getItem(SESSION_KEY); if (s) currentUser = JSON.parse(s); } catch { }
            updateAuthUI();

            Q('#auth-toggle').addEventListener('click', () => {
                if (currentUser) {
                    // Logout logic
                    localStorage.removeItem(SESSION_KEY);
                    currentUser = null;
                    updateAuthUI();
                    refreshFiltersAndTable();
                    toast('üö™ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑÿ¢ŸÜ');
                } else {
                    // Open Login modal
                    Q('#lg-user').value = ''; Q('#lg-pass').value = ''; Q('#lg-error').textContent = '';
                    Q('#login-backdrop').style.display = 'flex';
                }
            });

            Q('#lg-ok').addEventListener('click', () => {
                const u = Q('#lg-user').value.trim(), p = Q('#lg-pass').value;
                const found = AUTH_USERS.find(x => x.u === u && x.p === p);
                if (found) {
                    currentUser = { u: found.u, role: found.role };
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    Q('#login-backdrop').style.display = 'none';
                    toast('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
                } else {
                    currentUser = { u: u || 'guest', role: 'guest' };
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    Q('#lg-error').textContent = 'ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©. ÿ™ŸÖ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÇÿßÿ±ÿ¶ ŸÅŸÇÿ∑.';
                }

                updateAuthUI();
                refreshFiltersAndTable();
            });
            Q('#lg-cancel').addEventListener('click', () => Q('#login-backdrop').style.display = 'none');

            // Location Modal Events
            Q('#loc-cancel').addEventListener('click', () => Q('#loc-backdrop').style.display = 'none');
            Q('#loc-refresh').addEventListener('click', fetchLocation);
            Q('#loc-save').addEventListener('click', async () => {
                if (!activeLocRow || !activeLocCol) return;
                const coords = Q('#loc-coords').textContent;
                const [lat, lng] = coords.split(',').map(s => s.trim());

                // Save into separate columns
                activeLocRow[activeLocCol + ' lat'] = lat;
                activeLocRow[activeLocCol + ' long'] = lng;

                Q('#loc-backdrop').style.display = 'none';
                try {
                    await saveAll();
                    toast('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ');
                    refreshFiltersAndTable();
                } catch (e) {
                    alert('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + (e && e.message ? e.message : e));
                }
            });

            const exportBtn = Q('#btn-export');
            if (exportBtn) exportBtn.addEventListener('click', exportTableAsPDF);

            Q('#stat').textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...';
            try {
                const data = await readFromDrive(FILE_ID);
                const first = data[0] || {};
                headerOrder = Object.keys(first).map(normalizeKey);
                rows = data.map((r, i) => { const n = normalizeRowKeys(r); n.__id = String(i); return n; });

                FILTER_KEYS.forEach(key => {
                    const selEl = Q('#f-' + key);
                    const opts = optionsFor(key, { exch: '', msan: '', cabinet: '', dp: '', group: '' });
                    setSelectOptions(selEl, opts, '');
                    selEl.addEventListener('change', refreshFiltersAndTable);
                });

                Q('#btn-solved-only').addEventListener('click', () => setViewMode('solved'));
                Q('#btn-unsolved-only').addEventListener('click', () => setViewMode('unsolved'));

                viewMode = 'all';
                refreshFiltersAndTable();

                // Final sanity check for UI
                setTimeout(() => {
                    if (displayed.length === 0 && filtered.length > 0) {
                        refreshFiltersAndTable();
                    }
                    Q('#stat').textContent = `‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ: ${rows.length} ÿµŸÅ (ÿßŸÑŸÖÿπÿ±Ÿàÿ∂: ${displayed.length})`;
                }, 300);
            } catch (e) {
                Q('#stat').textContent = 'ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ Google Drive';
                alert('ÿ™ÿπÿ∞ÿ± ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÖŸÜ Google Drive. ÿ±ÿßÿ¨ÿπ ŸÜÿ¥ÿ± ÿßŸÑŸàŸäÿ® ÿ¢ÿ® ŸàÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™.\n' + (e && e.message ? e.message : e));
            }
        })();
    </script>
</body>

</html>
