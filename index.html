<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>requests portal</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --surface: #fff;
            --text: #0f1222;
            --muted: #606b85;
            --accent: #3b82f6;
            --ok: #22c55e;
            --border: #e6e9f1;
            --chip: #f0f3fa;
            --r: 8px;
            --danger: #ef4444;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0d12;
                --surface: #11141b;
                --text: #e9edf5;
                --muted: #a7b0c5;
                --accent: #60a5fa;
                --ok: #34d399;
                --border: #2a2f3a;
                --chip: #1a1f2a;
                --danger: #f87171;
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            font-size: 14px;
            padding-bottom: env(safe-area-inset-bottom)
        }

        a {
            color: inherit
        }

        /* Header - compact */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 8px 12px
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 800
        }

        .muted {
            color: var(--muted);
            font-size: 0.75rem;
            margin-top: 2px
        }

        .userbar {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap
        }

        .userpill {
            display: inline-flex;
            gap: .3rem;
            align-items: center;
            padding: .25rem .5rem;
            border: 1px solid var(--border);
            background: var(--chip);
            border-radius: 999px;
            font-weight: 700;
            font-size: .75rem
        }

        .linkish {
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 2px
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            margin: 8px
        }

        /* Filters - 2 per row, minimal */
        .filters-card {
            position: sticky;
            top: 52px;
            z-index: 40;
            overflow: hidden
        }

        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 8px;
            padding: 8px;
            max-width: 100%
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-weight: 700;
            font-size: .75rem;
            min-width: 0;
            overflow: hidden
        }

        select {
            height: 32px;
            padding: 0 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #fff;
            color: #0f1222;
            font-size: .8rem;
            width: 100%;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box
        }

        .actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 8px 8px
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            padding: .35rem .55rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--chip);
            font-weight: 700;
            font-size: .7rem;
            cursor: pointer;
            white-space: nowrap
        }

        .toggle[aria-pressed="true"] {
            outline: 2px solid var(--accent);
        }

        .count {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            padding: .25rem .5rem;
            border: 1px solid var(--border);
            border-radius: 999px;
            background: var(--chip);
            font-weight: 800;
            font-size: .7rem;
            white-space: nowrap
        }

        /* Smaller export button with less rounded corners */
        .export-btn {
            min-height: 30px;
            padding: .2rem .45rem;
            border-radius: 6px;
            font-size: .7rem;
        }

        /* Table - full width on mobile */
        .table-container {
            padding: 8px
        }

        .tablewrap {
            max-height: calc(100vh - 420px);
            overflow: auto;
            border-radius: 6px;
            background: var(--surface);
            border: 1px solid var(--border)
        }

        .tablewrap::-webkit-scrollbar {
            width: 8px;
            height: 8px
        }

        .tablewrap::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 999px
        }

        .tablewrap::-webkit-scrollbar-track {
            background: transparent
        }

        table {
            width: 100%;
            min-width: 800px;
            border-collapse: separate;
            border-spacing: 0;
            font-size: .75rem
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: var(--surface);
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            padding: .4rem .3rem;
            font-size: .7rem
        }

        th,
        td {
            padding: .4rem .3rem;
            border-bottom: 1px solid var(--border);
            text-align: right;
            vertical-align: top
        }

        tbody tr:active {
            background: var(--chip);
        }

        /* selected row highlight (light blue) */
        tbody tr.selected-row {
            background: #dbeafe !important;
            /* light blue */
        }

        textarea {
            width: 100%;
            min-height: 50px;
            resize: vertical;
            padding: .4rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #fff;
            color: #0f1222;
            font-size: .75rem
        }

        textarea[readonly] {
            opacity: .65;
            background: #e5e7eb;
        }

        .solved-cell {
            display: flex;
            align-items: center;
            gap: .35rem;
            flex-wrap: nowrap
        }

        .solved-cell .pill {
            display: inline-block;
            padding: .15rem .4rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: .7rem;
            background: var(--chip)
        }

        .solved-cell .pill.ok {
            background: #bbf7d0;
            color: #064e2a;
            border-color: transparent
        }

        .solved-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0
        }

        .solved-cell input[type="checkbox"][disabled] {
            cursor: not-allowed;
            opacity: .55
        }

        #measure {
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            top: -9999px;
            inset-inline-start: -9999px;
            font: inherit;
            padding: .4rem .3rem
        }

        /* Modals - optimized for mobile */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .3)
        }

        .modal .btns {
            display: flex;
            gap: 6px;
            margin-top: 10px
        }

        .btn {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: .5rem .9rem;
            cursor: pointer;
            font-weight: 700;
            background: var(--chip);
            font-size: .85rem;
            flex: 1
        }

        .btn.primary {
            background: linear-gradient(180deg, var(--accent), #2563eb);
            color: #fff;
            border-color: transparent
        }

        .login-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 16px
        }

        .login {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 14px 36px rgba(0, 0, 0, .4)
        }

        .login h3 {
            margin: 0 0 10px;
            font-size: 1.1rem
        }

        .login .row {
            display: grid;
            gap: 4px;
            margin: 8px 0
        }

        .login input {
            height: 38px;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0 10px;
            background: #fff;
            color: #0f1222;
            font-size: .85rem
        }

        .login .hint {
            color: var(--muted);
            font-size: .75rem;
            line-height: 1.3
        }

        .login .error {
            color: var(--danger);
            min-height: 1em;
            font-weight: 700;
            font-size: .8rem
        }

        .footer-note {
            padding: 6px 8px;
            font-size: .7rem;
            color: var(--muted)
        }

        /* Improve touch targets */
        button,
        select,
        input[type="checkbox"],
        .linkish {
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center
        }

        .toggle,
        .count {
            min-height: 36px
        }

        .tel-link {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }

        .loc-btn {
            padding: 4px 12px;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-height: 32px;
            width: auto;
            /* Fits text to button width */
            justify-content: center;
            border: none;
            font-weight: 600;
            white-space: nowrap;
            transition: transform 0.1s ease, filter 0.1s ease;
        }

        .loc-btn.has-data {
            background: #dcfce7;
            /* Light Green */
            color: #166534;
            /* Dark Green */
        }

        .loc-btn.no-data {
            background: #fee2e2;
            /* Light Red */
            color: #991b1b;
            /* Dark Red */
        }

        .loc-btn:hover {
            filter: brightness(0.95);
        }

        .loc-btn:active {
            transform: scale(0.96);
        }
    </style>
</head>

<body>
    <header>
        <div class="userbar">
            <div style="flex:1">
                <h1>requests portal</h1>
                <div class="muted">requests portal</div>
            </div>
            <div class="userpill">
                <span id="user-badge">ğŸš« ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</span>
                <span id="signin" class="linkish" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„">Ø¯Ø®ÙˆÙ„</span>
                <span>Â·</span>
                <span id="signout" class="linkish" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">Ø®Ø±ÙˆØ¬</span>
            </div>
        </div>
    </header>

    <main>
        <section class="card filters-card">
            <div class="filters">
                <label>exch <select id="f-exch">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select></label>
                <label>msan <select id="f-msan">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select></label>
                <label>cabinet <select id="f-cabinet">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select></label>
                <label>dp <select id="f-dp">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select></label>
                <label>group <select id="f-group">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select></label>
                <button id="btn-export" class="toggle export-btn" type="button" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒÙ…Ù„Ù PDF">ğŸ“„ ØªØµØ¯ÙŠØ±
                    PDF</button>
            </div>
            <div class="actions">
                <button id="btn-solved-only" class="toggle" aria-pressed="false">ğŸ‘ï¸ Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø© ÙÙ‚Ø·</button>
                <button id="btn-unsolved-only" class="toggle" aria-pressed="false">ğŸ‘ï¸ ØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</button>
                <span class="count">Ø§Ù„ÙƒÙ„: <span id="count-total">0</span></span>
                <span class="count">ØªÙ…: <span id="count-solved">0</span></span>
            </div>
            <div class="muted" style="padding:0 8px 8px;font-size:.7rem" id="stat"></div>
        </section>

        <section class="card">
            <div class="table-container">
                <div class="tablewrap" id="tablewrap">
                    <table id="tbl">
                        <colgroup id="colgroup"></colgroup>
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="footer-note">Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…Ø®ÙˆÙ„Ù‹Ø§ Ø³ØªØ¸Ù‡Ø± Ø§Ù„ØµÙØ­Ø© Ø¨ÙˆØ¶Ø¹ <b>Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</b>.</div>
        </section>
    </main>

    <div id="measure"></div>

    <!-- Confirm modal -->
    <div class="modal-backdrop" id="confirm-backdrop" aria-hidden="true">
        <div class="modal">
            <p id="confirm-text" style="margin:0 0 10px;font-size:.9rem">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</p>
            <div class="btns">
                <button class="btn primary" id="confirm-yes">Ù†Ø¹Ù…</button>
                <button class="btn" id="confirm-no">Ù„Ø§</button>
            </div>
        </div>
    </div>

    <!-- Location modal -->
    <div class="modal-backdrop" id="loc-backdrop">
        <div class="modal">
            <h3 style="margin-top:0">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
            <div id="loc-status" style="font-size:.85rem; margin-bottom:10px">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª...</div>

            <!-- Map Container -->
            <div id="map"
                style="height: 250px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border); background: var(--chip); z-index: 1;">
            </div>

            <div id="loc-coords"
                style="font-family:monospace; background:var(--chip); padding:8px; border-radius:6px; margin-bottom:10px; display:none; text-align:center; font-weight:bold; font-size:1.1rem">
            </div>
            <div class="btns">
                <button class="btn primary" id="loc-save" style="display:none">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                <button class="btn" id="loc-refresh">ØªØ­Ø¯ÙŠØ«</button>
                <button class="btn" id="loc-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Login modal -->
    <div class="login-backdrop" id="login-backdrop">
        <div class="login">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <div class="hint">Ø£Ø¯ÙˆØ§Ø±: <b>Team Leader</b> Ù„Ù„ØªØ­Ø±ÙŠØ± â€” <b>Closer</b> Ù„Ù„ØºÙ„Ù‚ ÙÙ‚Ø·.</div>
            <div class="row">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input id="lg-user" autocomplete="username" />
            </div>
            <div class="row">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input id="lg-pass" type="password" autocomplete="current-password" />
            </div>
            <div class="error" id="lg-error"></div>
            <div class="btns">
                <button class="btn primary" id="lg-ok">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn" id="lg-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
            <div class="hint" style="margin-top:8px">Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ø³ØªØ¯Ø®Ù„ Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·.</div>
        </div>
    </div>

    <!-- Map and Canvas libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        /* ===== CONFIG ===== */
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyptmXFXQCWEMWmy_84wk6I-Q78uI19aKIvVX_2pwKlsspmItPLOAuWFkCvZjlz63DB/exec';
        const FILE_ID = '1Eb2BFY1OsfL-EqM7nmMtZ-iaBH9BMBrl';
        const API_KEY = '';
        const UI_TZ = 'Africa/Cairo';

        /* ===== SIMPLE AUTH with ROLES ===== */
        const AUTH_USERS = [
            { u: 'admin', p: '1234', role: 'admin' },
            { u: 'closer', p: 'close123', role: 'closer' },
            { u: 'south', p: 's123', role: 'group' },
            { u: 'middle', p: 'm123', role: 'group' },
            { u: 'north', p: 'n123', role: 'group' },
            { u: 'group1', p: 'g123', role: 'group' },
            { u: 'waleed', p: 'w123', role: 'team_leader' },
            { u: 'nasr', p: 'n123', role: 'team_leader' },
            { u: 'ahmed', p: 'a123', role: 'team_leader' }
        ];
        const SESSION_KEY = 'reqs_login_user_v2';
        const TEAM_LEADER_EDITABLE_COLS = ['notes', 'msan', 'cabinet', 'dp', 'type'];

        /* ===== Utils ===== */
        const Q = (s, el = document) => el.querySelector(s);
        const QQ = (s, el = document) => Array.from(el.querySelectorAll(s));
        const val = (r, k) => {
            if (!r) return '';
            const lk = String(k).toLowerCase().trim();
            // Try lowercase variant first (as we normalize rows to lowercase keys)
            if (r[lk] !== undefined) return (r[lk] ?? '').toString().trim();
            // Fallback to exact key if normalization failed
            return (r[k] ?? '').toString().trim();
        };

        function toast(message, ms = 1800) {
            const t = document.createElement('div');
            t.textContent = message;
            Object.assign(t.style, {
                position: 'fixed', left: '50%', transform: 'translateX(-50%)',
                bottom: '20px', zIndex: '2147483647',
                background: 'var(--surface)', color: 'var(--text)',
                border: '1px solid var(--border)', padding: '.6rem .9rem',
                borderRadius: '8px', boxShadow: '0 8px 22px rgba(0,0,0,.18)',
                fontWeight: '700', pointerEvents: 'none', fontSize: '.85rem',
                opacity: '0', transition: 'opacity .18s ease',
            });
            document.body.appendChild(t);
            requestAnimationFrame(() => { t.style.opacity = '1'; });
            setTimeout(() => { t.style.opacity = '0'; }, Math.max(250, ms - 200));
            setTimeout(() => { t.remove(); }, ms + 50);
        }

        function askConfirm(text) {
            return new Promise(resolve => {
                const bd = Q('#confirm-backdrop');
                const yes = Q('#confirm-yes'), no = Q('#confirm-no'), p = Q('#confirm-text');
                p.textContent = text;
                bd.style.display = 'flex';
                function cleanup() { bd.style.display = 'none'; yes.onclick = no.onclick = bd.onclick = null; }
                yes.onclick = () => { cleanup(); resolve(true); };
                no.onclick = () => { cleanup(); resolve(false); };
                bd.onclick = (e) => { if (e.target === bd) { cleanup(); resolve(false); } };
            });
        }

        function nowStampCairo() {
            const d = new Date();
            const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: UI_TZ, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const parts = Object.fromEntries(fmt.formatToParts(d).map(p => [p.type, p.value]));
            return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second}`;
        }

        // ---- Excel helpers using SheetJS ----
        async function readFromDrive(id) {
            const url = `${APPS_SCRIPT_URL}?id=${encodeURIComponent(id)}`;
            console.log('Fetching from URL:', url);
            let resp;
            try {
                resp = await fetch(url, { cache: 'no-store' });
            } catch (networkError) {
                console.error('Fetch network error:', networkError);
                throw new Error('Network error (Failed to fetch). This usually means:\n1. The Script URL is wrong.\n2. You are not logged in or the script permissions are not set to "Anyone".\n3. CORS block because of a redirect to a login page.');
            }

            if (!resp.ok) throw new Error('Failed to fetch from script: HTTP ' + resp.status);

            const text = await resp.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                // If parsing fails, the script might be returning the old CSV text or a text error
                if (text.startsWith('<!doctype') || text.startsWith('<html')) {
                    throw new Error('Script returned HTML (Login page). Please check "Who has access: Anyone" in deployment.');
                }
                throw new Error('Script returned non-JSON data. This often happens if the Script URL is old or Permissions are wrong. \n\nContent starts with: ' + text.substring(0, 200));
            }

            if (result.error) throw new Error('Apps Script Error: ' + result.error);

            // Handle base64 from Apps Script
            const base64 = result.base64;
            const workbook = XLSX.read(base64, { type: 'base64' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];

            // Convert to JSON
            const data = XLSX.utils.sheet_to_json(sheet, { defval: "" });

            // Store header order from the Excel sheet
            if (data.length > 0) {
                headerOrder = XLSX.utils.sheet_to_json(sheet, { header: 1 })[0];
            }

            return data;
        }

        async function writeToDrive(id, rows) {
            // Create a new workbook and add the data
            const worksheet = XLSX.utils.json_to_sheet(rows, { header: headerOrder });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Requests");

            // Write as base64
            const b64 = XLSX.write(workbook, { type: 'base64', bookType: 'xlsx' });

            const url = `${APPS_SCRIPT_URL}?id=${encodeURIComponent(id)}&op=overwrite${API_KEY ? '&key=' + encodeURIComponent(API_KEY) : ''}`;
            const resp = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ base64: b64 })
            });

            const t = await resp.text();
            if (!resp.ok || (t && t.startsWith('ERROR'))) throw new Error(t || ('HTTP ' + resp.status));
            return true;
        }
        function normalizeKey(k) {
            let nk = String(k || '').trim().toLowerCase();
            if (nk === 'msan ') nk = 'msan';
            if (nk === 'solved by') nk = 'solved_by';
            if (nk === 'team leader') nk = 'team_leader';
            return nk;
        }
        function normalizeRowKeys(r) {
            const o = {};
            for (const k of Object.keys(r)) {
                o[normalizeKey(k)] = r[k];
            }
            return o;
        }

        /* ===== State ===== */
        let rows = [], headerOrder = [];
        let filtered = [], displayed = [];
        let viewMode = 'all';
        let currentUser = null;
        let canEdit = false;
        let canClose = false;
        let isTeamLeader = false;
        let isGroup = false;
        let selectedRowEl = null;
        let activeLocRow = null;
        let activeLocCol = null;
        let leafletMap = null;
        let leafletUserMarker = null;
        let leafletTargetMarker = null;
        let locViewMode = false;

        /* ===== Filtering / rendering ===== */
        const FILTER_KEYS = ['exch', 'msan', 'cabinet', 'dp', 'group'];

        function matches(r, s) {
            if (!s) return true;
            const m = (k, v) => {
                const query = (v || '').toString().trim().toLowerCase();
                if (!query || query === 'Ø§Ù„ÙƒÙ„') return true;
                const rowVal = val(r, k).toLowerCase();
                return rowVal === query;
            };
            return m('exch', s.exch) && m('msan', s.msan) && m('cabinet', s.cabinet) && m('dp', s.dp) && m('group', s.group);
        }

        function optionsFor(col, scope) {
            const set = new Set(rows.filter(r => matches(r, scope)).map(r => val(r, col)).filter(Boolean));
            return ['', ...Array.from(set).sort((a, b) => a.localeCompare(b, 'ar'))];
        }

        function currentSelection() {
            return {
                exch: Q('#f-exch').value.trim(),
                msan: Q('#f-msan').value.trim(),
                cabinet: Q('#f-cabinet').value.trim(),
                dp: Q('#f-dp').value.trim(),
                group: Q('#f-group').value.trim()
            };
        }

        function setSelectOptions(selEl, options, keepValue) {
            const prev = keepValue ?? selEl.value;
            selEl.innerHTML = options.map(v => `<option value="${v}">${v || 'Ø§Ù„ÙƒÙ„'}</option>`).join('');
            selEl.value = options.includes(prev) ? prev : '';
        }

        function refreshFiltersOnly() {
            const s = currentSelection();
            FILTER_KEYS.forEach(key => {
                const scope = { ...s, [key]: '' };
                const opts = optionsFor(key, scope);
                const selEl = Q('#f-' + key);
                setSelectOptions(selEl, opts, s[key]);
                s[key] = selEl.value.trim();
            });
        }

        function refreshFiltersAndTable() {
            refreshFiltersOnly();
            const s = currentSelection();

            // Filter based on dropdowns
            filtered = rows.filter(r => matches(r, s));

            const isAdmin = currentUser && currentUser.role === 'admin';

            // Row-level Security
            if (currentUser && !isAdmin) {
                const u = (currentUser.u || '').toLowerCase().trim();
                if (isTeamLeader) {
                    filtered = filtered.filter(r => {
                        const tl = val(r, 'team_leader').toLowerCase().trim();
                        return tl === u || tl.includes(u);
                    });
                }
                // Group role now sees all rows (No filter)
            }

            applyViewMode();
            renderTable(displayed);
            updateCounters();
            Q('#stat').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${displayed.length}`;
        }

        function applyViewMode() {
            if (viewMode === 'solved') displayed = filtered.filter(r => val(r, 'solved').toLowerCase() === 'ok');
            else if (viewMode === 'unsolved') displayed = filtered.filter(r => val(r, 'solved').toLowerCase() !== 'ok');
            else displayed = filtered.slice();
            updateViewButtons();
        }
        function updateViewButtons() {
            const btnS = Q('#btn-solved-only'), btnU = Q('#btn-unsolved-only');
            btnS.setAttribute('aria-pressed', viewMode === 'solved'); btnU.setAttribute('aria-pressed', viewMode === 'unsolved');
            btnS.textContent = viewMode === 'solved' ? 'â†©ï¸ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„' : 'ğŸ‘ï¸ Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø© ÙÙ‚Ø·';
            btnU.textContent = viewMode === 'unsolved' ? 'â†©ï¸ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„' : 'ğŸ‘ï¸ ØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©';
        }
        function setViewMode(newMode) { viewMode = (viewMode === newMode) ? 'all' : newMode; refreshFiltersAndTable(); }

        function updateCounters() {
            Q('#count-total').textContent = filtered.length;
            Q('#count-solved').textContent = filtered.filter(r => val(r, 'solved').toLowerCase() === 'ok').length;
        }

        function ensureColumnsOrder(baseCols) {
            let cols = baseCols.slice();

            const extra = [
                'customer loc', 'dp loc',
                'customer loc lat', 'customer loc long',
                'dp loc lat', 'dp loc long',
                'comment', 'solved', 'solved_at', 'solved_by', 'closed', 'team_leader'
            ];

            // Add missing columns (case-insensitive check)
            extra.forEach(k => {
                if (!cols.some(c => c.toLowerCase().trim() === k)) {
                    cols.push(k);
                }
            });

            const move = (arr, fromKey, toIndex) => {
                const i = arr.findIndex(c => String(c).toLowerCase().trim() === fromKey);
                if (i > -1 && i !== toIndex) { const [x] = arr.splice(i, 1); arr.splice(Math.min(toIndex, arr.length), 0, x); }
            };

            const typeIdx = cols.findIndex(c => String(c).toLowerCase().trim() === 'type');
            if (typeIdx > -1) {
                const startIdx = typeIdx + 1;
                move(cols, 'dp loc lat', startIdx);
                move(cols, 'dp loc long', startIdx + 1);
                move(cols, 'dp loc', startIdx + 2);
                move(cols, 'customer loc lat', startIdx + 3);
                move(cols, 'customer loc long', startIdx + 4);
                move(cols, 'customer loc', startIdx + 5);
            }

            const idxSolved = cols.findIndex(c => String(c).toLowerCase().trim() === 'solved');
            if (idxSolved > -1) {
                move(cols, 'solved_at', idxSolved + 1);
                move(cols, 'solved_by', idxSolved + 2);
                move(cols, 'closed', idxSolved + 3);
            }

            // Hide internal coordinate columns from the visible array used for table rendering
            const hidden = ['customer loc lat', 'customer loc long', 'dp loc lat', 'dp loc long'];
            return cols.filter(c => !hidden.includes(c.toLowerCase().trim()));
        }

        function renderTable(rowsToShow) {
            const thead = Q('#tbl thead'), tbody = Q('#tbl tbody');
            const baseCols = headerOrder.map(h => (h.trim() === 'msan' || h.trim() === 'msan ') ? 'msan' : h.trim());
            const cols = ensureColumnsOrder(baseCols);
            thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';

            const rowHtml = r => cols.map(c => {
                const lc = String(c).toLowerCase().trim();
                if (lc === 'comment') {
                    const v = r[lc] ?? val(r, c);
                    const ro = (canEdit || isGroup) ? '' : 'readonly';
                    return `<td><textarea data-id="${r.__id}" data-col="${lc}" ${ro}>${(v + '').replace(/</g, '&lt;')}</textarea></td>`;
                } else if (TEAM_LEADER_EDITABLE_COLS.includes(lc)) {
                    const v = r[lc] ?? val(r, c);
                    const isAdmin = currentUser && (currentUser.u === 'admin' || currentUser.isAdmin === true);
                    const ro = (canEdit || isAdmin) ? '' : 'readonly';
                    return `<td><input type="text" value="${(v + '').replace(/"/g, '&quot;')}" data-id="${r.__id}" data-col="${lc}" ${ro} style="width:100%; border:none; background:transparent; font-size:inherit; color:inherit; padding:2px;"></td>`;
                } else if (lc === 'solved') {
                    const isOk = val(r, 'solved').toLowerCase() === 'ok';
                    const pill = isOk ? `<span class="pill ok">ok</span>` : `<span class="pill">â€”</span>`;
                    const ro = (canEdit || isGroup);
                    const dis = ro ? '' : 'disabled';
                    const tt = ro ? 'ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù„' : 'ØºÙŠØ± Ù…Ø®ÙˆÙ„ (Team Leader/Group ÙÙ‚Ø·)';
                    return `<td>
                  <div class="solved-cell">
                    <input type="checkbox" data-id="${r.__id}" data-col="solved" ${isOk ? 'checked' : ''} ${dis} title="${tt}">
                    ${pill}
                  </div>
                </td>`;
                } else if (lc === 'closed') {
                    const isClosed = ['yes', 'ok', '1', 'true'].includes(val(r, 'closed').toLowerCase());
                    const dis = canClose ? '' : 'disabled';
                    const tt = canClose ? 'ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØºÙ„Ù‚' : 'ØºÙŠØ± Ù…Ø®ÙˆÙ„ (Closer ÙÙ‚Ø·)';
                    return `<td>
                  <div class="solved-cell">
                    <input type="checkbox" data-id="${r.__id}" data-col="closed" ${isClosed ? 'checked' : ''} ${dis} title="${tt}">
                    <span class="pill">${isClosed ? 'yes' : 'â€”'}</span>
                  </div>
                </td>`;
                } else if (lc === 'customer loc' || lc === 'dp loc') {
                    const lat = val(r, lc + ' lat'), long = val(r, lc + ' long');
                    const hasData = lat && long;
                    const label = hasData ? 'Ø§Ù„Ù…ÙˆÙ‚Ø¹' : (val(r, lc) || 'ØªØ­Ø¯ÙŠØ¯');
                    const btnClass = hasData ? 'has-data' : 'no-data';
                    return `<td>
                  <div style="display:flex; align-items:center; gap:4px; justify-content:center;">
                    <button class="loc-btn ${btnClass}" data-id="${r.__id}" data-col="${lc}" title="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                      ğŸ“ ${label}
                    </button>
                  </div>
                </td>`;
                } else if (['customer loc lat', 'customer loc long', 'dp loc lat', 'dp loc long'].includes(lc)) {
                    return `<td style="opacity:0.5; font-size:0.65rem;">${val(r, c)}</td>`;
                } else {
                    const v = val(r, c);
                    if (lc === 'mob') {
                        const clean = v.replace(/\s+/g, '');
                        return `<td>${v ? `<a class="tel-link" href="tel:${clean}">${v}</a>` : ''}</td>`;
                    }
                    return `<td>${v}</td>`;
                }
            }).join('');
            tbody.innerHTML = rowsToShow.map(r => `<tr>${rowHtml(r)}</tr>`).join('');

            autoFitColumns(cols, rowsToShow);

            selectedRowEl = null;
            QQ('#tbl tbody tr').forEach(tr => {
                tr.addEventListener('click', () => {
                    if (selectedRowEl && selectedRowEl !== tr) {
                        selectedRowEl.classList.remove('selected-row');
                    }
                    selectedRowEl = tr;
                    selectedRowEl.classList.add('selected-row');
                });
            });

            if (canEdit || isGroup) {
                QQ('textarea[data-id], input[data-col][data-id]').forEach(inp => {
                    const id = inp.getAttribute('data-id');
                    const col = inp.getAttribute('data-col');
                    if (col === 'solved' || col === 'closed') return; // Handled separately
                    const row = rows.find(x => x.__id === id);
                    const orig = row ? (row[col] ?? '') : '';

                    inp.addEventListener('blur', async () => {
                        const v = inp.value; if (v === orig) return;

                        // Restriction: Group can only edit comment
                        if (isGroup && col !== 'comment') {
                            inp.value = orig;
                            toast('ğŸš« ØºÙŠØ± Ù…Ø®ÙˆÙ„ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„');
                            return;
                        }

                        const msg = col === 'comment' ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ' : `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ (${col})ØŸ`;
                        const ok = await askConfirm(msg);
                        if (!ok) { inp.value = orig; return; }
                        row[col] = v;
                        try { await saveAll(); toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚'); refreshFiltersAndTable(); }
                        catch (e) { alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (e && e.message ? e.message : e)); }
                    });
                });

                QQ('td .solved-cell input[type="checkbox"][data-col="solved"]').forEach(chk => {
                    chk.addEventListener('change', async () => {
                        const id = chk.getAttribute('data-id');
                        const row = rows.find(x => x.__id === id);
                        const wasChecked = (val(row, 'solved').toLowerCase() === 'ok');
                        const isChecked = chk.checked;

                        // Check if Group has permission
                        if (!canEdit && !isGroup) {
                            chk.checked = wasChecked;
                            toast('ğŸš« ØºÙŠØ± Ù…Ø®ÙˆÙ„');
                            return;
                        }

                        const msg = isChecked ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ… Ø§Ù„Ø­Ù„)ØŸ' : 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© (ØªÙ… Ø§Ù„Ø­Ù„)ØŸ';
                        const ok = await askConfirm(msg);
                        if (!ok) { chk.checked = wasChecked; return; }
                        if (isChecked) {
                            row.solved = 'ok';
                            row.solved_at = nowStampCairo();
                            if (currentUser && currentUser.u) row.solved_by = currentUser.u;
                        } else {
                            row.solved = '';
                            row.solved_at = '';
                            row.solved_by = '';
                        }
                        try { await saveAll(); toast(isChecked ? 'âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'â†©ï¸ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡'); refreshFiltersAndTable(); }
                        catch (e) { chk.checked = wasChecked; alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (e && e.message ? e.message : e)); }
                    });
                });
            }

            if (canClose) {
                QQ('td .solved-cell input[type="checkbox"][data-col="closed"]').forEach(chk => {
                    chk.addEventListener('change', async () => {
                        const id = chk.getAttribute('data-id');
                        const row = rows.find(x => x.__id === id);
                        const wasChecked = ['yes', 'ok', '1', 'true'].includes(val(row, 'closed').toLowerCase());
                        const isChecked = chk.checked;
                        const msg = isChecked ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ØºÙ„Ù‚)ØŸ' : 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© (Ù…ØºÙ„Ù‚)ØŸ';
                        const ok = await askConfirm(msg);
                        if (!ok) { chk.checked = wasChecked; return; }
                        row.closed = isChecked ? 'yes' : '';
                        try { await saveAll(); toast(isChecked ? 'âœ… ØªÙ… Ø§Ù„ØºÙ„Ù‚' : 'â†©ï¸ ØªÙ… Ø§Ù„ÙØªØ­'); refreshFiltersAndTable(); }
                        catch (e) { chk.checked = wasChecked; alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (e && e.message ? e.message : e)); }
                    });
                });
            }

            if (canEdit || canClose || isGroup) {
                QQ('.loc-btn[data-id]').forEach(btn => {
                    const hasData = btn.classList.contains('has-data');
                    // Group users can ONLY click if there is data. Tech/Closer can click anytime.
                    const clickable = (canEdit || canClose) || (isGroup && hasData);

                    if (clickable) {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = btn.getAttribute('data-id');
                            const col = btn.getAttribute('data-col');
                            const row = rows.find(x => x.__id === id);
                            showLocModal(row, col);
                        });
                    } else {
                        btn.style.cursor = 'default';
                        btn.title = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±';
                    }
                });
            }
        }

        function showLocModal(row, col) {
            activeLocRow = row;
            activeLocCol = col;

            const lat = val(row, col + ' lat'), lng = val(row, col + ' long');
            const hasData = lat && lng;
            locViewMode = (isGroup && hasData);

            Q('#loc-backdrop').style.display = 'flex';
            Q('#loc-save').style.display = locViewMode ? 'none' : 'none'; // Initially hidden
            Q('#loc-refresh').textContent = locViewMode ? 'ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ÙŠ' : 'ØªØ­Ø¯ÙŠØ«';
            Q('#loc-cancel').textContent = locViewMode ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Ø¥Ù„ØºØ§Ø¡';
            Q('h3', Q('#loc-backdrop')).textContent = locViewMode ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹' : 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';

            // Initialize or Resize Map
            if (!leafletMap) {
                leafletMap = L.map('map').setView([24.0, 32.8], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(leafletMap);
            } else {
                setTimeout(() => leafletMap.invalidateSize(), 100);
            }

            // Target Marker (Red)
            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            if (hasData) {
                const targetPos = [parseFloat(lat), parseFloat(lng)];
                if (!leafletTargetMarker) {
                    leafletTargetMarker = L.marker(targetPos, { icon: redIcon }).addTo(leafletMap).bindPopup('Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø®Ø²Ù†');
                } else {
                    leafletTargetMarker.setLatLng(targetPos).addTo(leafletMap);
                }
            } else {
                if (leafletTargetMarker) leafletMap.removeLayer(leafletTargetMarker);
            }

            fetchLocation();
        }

        function fetchLocation() {
            const status = Q('#loc-status');
            const coordsDiv = Q('#loc-coords');
            const saveBtn = Q('#loc-save');

            status.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª...';
            coordsDiv.style.display = 'none';
            saveBtn.style.display = 'none';

            if (!navigator.geolocation) {
                status.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.';
                return;
            }

            // Check for secure context (HTTPS requirement for mobile)
            const isSecure = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost';

            if (!isSecure) {
                status.innerHTML = `<div style="color:var(--danger); line-height:1.4;">
                    âš ï¸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØªØ·Ù„Ø¨ Ø§ØªØµØ§Ù„ Ø¢Ù…Ù† (HTTPS).<br>
                    <small>ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App Ø§Ù„Ù…ÙˆØ¬Ù‡ Ù…Ù† Google Apps Script Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ù€ GPS Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ.</small>
                </div>`;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    const latlng = [parseFloat(lat), parseFloat(lng)];

                    coordsDiv.textContent = `${lat}, ${lng}`;
                    coordsDiv.style.display = 'block';
                    status.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­:';
                    saveBtn.style.display = locViewMode ? 'none' : 'inline-block';

                    // Update User Marker (Blue)
                    if (leafletMap) {
                        if (!leafletUserMarker) {
                            leafletUserMarker = L.marker(latlng).addTo(leafletMap).bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
                        } else {
                            leafletUserMarker.setLatLng(latlng).addTo(leafletMap);
                        }

                        if (locViewMode && leafletTargetMarker) {
                            const group = new L.featureGroup([leafletUserMarker, leafletTargetMarker]);
                            leafletMap.fitBounds(group.getBounds().pad(0.2));
                        } else {
                            leafletMap.setView(latlng, 16);
                        }
                    }
                },
                (err) => {
                    console.error('Geolocation error:', err);
                    let msg = 'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.';
                    if (err.code === 1) msg = 'ğŸš« ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„Ù‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.';
                    else if (err.code === 2) msg = 'âŒ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹.';
                    else if (err.code === 3) msg = 'â³ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.';
                    status.innerHTML = `<span style="color:var(--danger)">${msg}</span>`;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function autoFitColumns(cols, rowsToShow) {
            const meas = Q('#measure'); const colgroup = Q('#colgroup'); colgroup.innerHTML = '';
            const wide = new Set(['address', 'notes', 'name', 'comment', 'solved_at', 'solved_by']);
            const sampleN = Math.min(rowsToShow.length, 80);
            cols.forEach((c) => {
                meas.style.whiteSpace = 'nowrap'; meas.textContent = c; let w = meas.offsetWidth;
                for (let i = 0; i < sampleN; i++) {
                    const r = rowsToShow[i];
                    const txt = (r && r[c] != null) ? String(r[c]) : '';
                    meas.textContent = txt;
                    w = Math.max(w, meas.offsetWidth);
                }
                w += 16;
                const minN = 60, maxN = 140, minW = 120, maxW = 400;
                const isW = wide.has(String(c).toLowerCase());
                const finalW = Math.max(isW ? minW : minN, Math.min(w, isW ? maxW : maxN));
                const col = document.createElement('col');
                col.style.minWidth = finalW + 'px';
                colgroup.appendChild(col);
            });
        }

        async function saveAll() {
            const headers = headerOrder.map(h => (h.trim() === 'msan' || h.trim() === 'msan ') ? 'msan' : h.trim());
            const extraCols = [
                'customer loc', 'dp loc', 'customer loc lat', 'customer loc long',
                'dp loc lat', 'dp loc long', 'solved', 'comment', 'solved_at', 'solved_by', 'closed'
            ];
            for (const k of extraCols) if (!headers.includes(k)) headers.push(k);
            const material = rows.map(r => { const o = {}; headers.forEach(h => o[h] = r[h] ?? ''); return o; });

            Q('#stat').textContent = 'ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸...';
            await writeToDrive(FILE_ID, material);
            Q('#stat').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Google Drive';
        }

        // ===== EXPORT TO PDF: clone full table (all columns) =====
        async function exportTableAsPDF() {
            if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                alert('Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                return;
            }

            const srcTable = Q('#tbl');
            if (!srcTable) return;

            try {
                toast('ğŸ“„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...');

                // Off-screen container
                const exportRoot = document.createElement('div');
                exportRoot.style.position = 'fixed';
                exportRoot.style.left = '-100000px';
                exportRoot.style.top = '0';
                exportRoot.style.background = '#ffffff';
                exportRoot.style.direction = 'rtl';

                // Clone the REAL table (no scroll wrapper)
                const tbl = srcTable.cloneNode(true);
                tbl.removeAttribute('id');
                tbl.style.borderCollapse = 'collapse';
                tbl.style.width = '100%';
                tbl.style.tableLayout = 'fixed';
                tbl.style.fontSize = '9px';

                const colCount = tbl.querySelectorAll('thead th').length || 10;
                const exportWidth = Math.max(1600, colCount * 110);
                exportRoot.style.width = exportWidth + 'px';

                // Equal column widths
                const colgroup = tbl.querySelector('colgroup');
                if (colgroup) {
                    const cols = colgroup.querySelectorAll('col');
                    const percent = (100 / (cols.length || colCount)).toFixed(2) + '%';
                    cols.forEach(c => {
                        c.style.minWidth = '0';
                        c.style.width = percent;
                    });
                }

                // Convert textareas to simple divs so full text appears
                tbl.querySelectorAll('textarea').forEach(t => {
                    const div = document.createElement('div');
                    div.textContent = t.value || t.textContent || '';
                    div.style.whiteSpace = 'pre-wrap';
                    div.style.wordWrap = 'break-word';
                    div.style.wordBreak = 'break-word';
                    t.parentNode.replaceChild(div, t);
                });

                // Reset sticky headers, borders, wrapping
                tbl.querySelectorAll('thead th').forEach(th => {
                    th.style.position = 'static';
                    th.style.background = '#f3f4f6';
                    th.style.border = '1px solid #d1d5db';
                    th.style.padding = '4px';
                    th.style.whiteSpace = 'normal';
                    th.style.wordWrap = 'break-word';
                    th.style.wordBreak = 'break-word';
                });
                tbl.querySelectorAll('td').forEach(td => {
                    td.style.border = '1px solid #e5e7eb';
                    td.style.padding = '4px';
                    td.style.background = '#ffffff';
                    td.style.whiteSpace = 'normal';
                    td.style.wordWrap = 'break-word';
                    td.style.wordBreak = 'break-word';
                });
                tbl.querySelectorAll('tr').forEach(tr => {
                    tr.style.backgroundColor = '#ffffff';
                });
                tbl.querySelectorAll('.solved-cell .pill').forEach(p => {
                    p.style.background = '#e5f2ff';
                    p.style.border = '1px solid #bfdbfe';
                    p.style.color = '#111827';
                });

                exportRoot.appendChild(tbl);
                document.body.appendChild(exportRoot);

                const canvas = await html2canvas(exportRoot, {
                    scale: 2,
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'pt', 'a4'); // landscape

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 24;
                const imgWidth = pageWidth - margin * 2;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                let position = margin;
                let heightLeft = imgHeight;

                pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - margin * 2);

                while (heightLeft > 0) {
                    pdf.addPage();
                    position = margin - (imgHeight - heightLeft);
                    pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - margin * 2);
                }

                const stamp = nowStampCairo().replace(/[: ]/g, '-');
                const filename = `requests-${stamp}.pdf`;
                pdf.save(filename);

                toast('âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù Ø§Ù„Ù€ PDF');
                exportRoot.remove();
            } catch (e) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF.\n' + (e && e.message ? e.message : e));
            }
        }

        /* ===== Init ===== */
        (async function () {
            try { const s = localStorage.getItem(SESSION_KEY); if (s) currentUser = JSON.parse(s); } catch { }
            if (currentUser) {
                const r = currentUser.role;
                canEdit = (r === 'admin' || r === 'team_leader');
                canClose = (r === 'admin' || r === 'closer');
                isTeamLeader = (r === 'team_leader');
                isGroup = (r === 'group');
                const badge = Q('#user-badge');
                if (r === 'guest') badge.textContent = `ğŸ‘€ ${currentUser.u} (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)`;
                else {
                    const label = (currentUser.u === r) ? currentUser.u : `${currentUser.u} (${r})`;
                    badge.textContent = `âœ… ${label}`;
                }
            }

            Q('#signin').addEventListener('click', () => {
                Q('#lg-user').value = ''; Q('#lg-pass').value = ''; Q('#lg-error').textContent = '';
                Q('#login-backdrop').style.display = 'flex';
            });
            Q('#signout').addEventListener('click', () => {
                localStorage.removeItem(SESSION_KEY);
                currentUser = null; canEdit = false; canClose = false;
                Q('#user-badge').textContent = 'ğŸš« ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„';
                refreshFiltersAndTable();
                toast('ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†');
            });
            Q('#lg-ok').addEventListener('click', () => {
                const u = Q('#lg-user').value.trim(), p = Q('#lg-pass').value;
                const found = AUTH_USERS.find(x => x.u === u && x.p === p);
                if (found) {
                    currentUser = { u: found.u, role: found.role };
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    Q('#login-backdrop').style.display = 'none';
                    toast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                } else {
                    currentUser = { u: u || 'guest', role: 'guest' };
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    Q('#lg-error').textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ‚Ø§Ø±Ø¦ ÙÙ‚Ø·.';
                }

                const r = currentUser.role;
                canEdit = (r === 'admin' || r === 'team_leader');
                canClose = (r === 'admin' || r === 'closer');
                isTeamLeader = (r === 'team_leader');
                isGroup = (r === 'group');

                const badge = Q('#user-badge');
                if (r === 'guest') badge.textContent = `ğŸ‘€ ${currentUser.u} (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)`;
                else {
                    const label = (currentUser.u === r) ? currentUser.u : `${currentUser.u} (${r})`;
                    badge.textContent = `âœ… ${label}`;
                }

                refreshFiltersAndTable();
            });
            Q('#lg-cancel').addEventListener('click', () => Q('#login-backdrop').style.display = 'none');

            // Location Modal Events
            Q('#loc-cancel').addEventListener('click', () => Q('#loc-backdrop').style.display = 'none');
            Q('#loc-refresh').addEventListener('click', fetchLocation);
            Q('#loc-save').addEventListener('click', async () => {
                if (!activeLocRow || !activeLocCol) return;
                const coords = Q('#loc-coords').textContent;
                const [lat, lng] = coords.split(',').map(s => s.trim());

                // Save into separate columns
                activeLocRow[activeLocCol + ' lat'] = lat;
                activeLocRow[activeLocCol + ' long'] = lng;

                Q('#loc-backdrop').style.display = 'none';
                try {
                    await saveAll();
                    toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
                    refreshFiltersAndTable();
                } catch (e) {
                    alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (e && e.message ? e.message : e));
                }
            });

            const exportBtn = Q('#btn-export');
            if (exportBtn) exportBtn.addEventListener('click', exportTableAsPDF);

            Q('#stat').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            try {
                const data = await readFromDrive(FILE_ID);
                const first = data[0] || {};
                headerOrder = Object.keys(first).map(normalizeKey);
                rows = data.map((r, i) => { const n = normalizeRowKeys(r); n.__id = String(i); return n; });

                FILTER_KEYS.forEach(key => {
                    const selEl = Q('#f-' + key);
                    const opts = optionsFor(key, { exch: '', msan: '', cabinet: '', dp: '', group: '' });
                    setSelectOptions(selEl, opts, '');
                    selEl.addEventListener('change', refreshFiltersAndTable);
                });

                Q('#btn-solved-only').addEventListener('click', () => setViewMode('solved'));
                Q('#btn-unsolved-only').addEventListener('click', () => setViewMode('unsolved'));

                viewMode = 'all';
                refreshFiltersAndTable();

                // Final sanity check for UI
                setTimeout(() => {
                    if (displayed.length === 0 && filtered.length > 0) {
                        refreshFiltersAndTable();
                    }
                    Q('#stat').textContent = `âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${rows.length} ØµÙ (Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${displayed.length})`;
                }, 300);
            } catch (e) {
                Q('#stat').textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Google Drive';
                alert('ØªØ¹Ø°Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Google Drive. Ø±Ø§Ø¬Ø¹ Ù†Ø´Ø± Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.\n' + (e && e.message ? e.message : e));
            }
        })();
    </script>
</body>

</html>
